name: Node.js CI/CD on Amazon Linux

on:
  push:
    branches: [ master ]  # Only trigger on push to master branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v2
      with:
        ref: master

    - name: SSH to EC2 - Pull and Restart App
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.CICD_NODE_HOST }}
        username: ${{ secrets.CICD_NODE_USER }}
        key: ${{ secrets.CICD_NODE }}
        script: |
          set -e
          echo "ğŸ“ Navigating to project directory"
          cd /home/ubuntu/cicd_node/node_cicd || { echo 'âŒ Directory not found'; exit 1; }

          echo "ğŸ”„ Checking out master branch"
          git checkout master || { echo 'âŒ Failed to checkout master'; exit 1; }

          echo "ğŸ“¥ Pulling latest code"
          git pull origin master || { echo 'âŒ Git pull failed'; exit 1; }

          echo "ğŸ“¦ Installing dependencies"
          npm install || { echo 'âŒ npm install failed'; exit 1; }

          echo "ğŸš€ Restarting PM2 app"
          pm2 reload node_cicd || pm2 start index.js --name node_cicd || { echo 'âŒ PM2 restart/start failed'; exit 1; }
